# 流程角色冒烟测试清单（状态/权限/流程）

适用范围：
- 流程应用运行页（`/app/:workflowAppId`）
- 业务应用状态列（创建 / 生效 / 锁定）
- 权限码 `op:{aclModule}.status_transition.{from}_{to}`

目标：
- 快速确认“谁能办任务、谁能改状态、流程是否自动推进”三条链路正常。

## 一、测试前准备

1. 准备 3 个账号：`super_admin`、业务办理人（如员工）、业务复核人（如仓管/HR）。
2. 确认流程应用已配置：
- 业务应用绑定（按应用绑定，不是按表绑定）。
- 用户任务节点状态映射（建议：创建 / 生效 / 锁定）。
- 任务分派（候选角色或候选用户）。
- 自动推进规则（可开关，触发状态建议先用“生效”）。
3. 确认业务应用状态字段是同一真值源（`status`）。
4. 角色权限至少覆盖：
- 流程发起：`op:{aclModule}.workflow_start`
- 流程推进：`op:{aclModule}.workflow_transition`
- 状态迁移：`op:{aclModule}.status_transition.*` 或精确码

## 二、核心用例

1. 发起实例
- 步骤：业务办理人进入流程运行页，输入业务键（可选）后发起。
- 期望：实例创建成功，状态为进行中，实例表出现发起人。

2. 任务可见性
- 步骤：分别登录 3 个账号查看“员工页/管理员页”。
- 期望：仅分派命中的账号可执行当前任务；`super_admin` 可全量操作。

3. 业务页跳转
- 步骤：在流程实例点击“去业务处理”。
- 期望：跳转到已绑定业务应用（或 legacy 路由），无 404/空白。

4. 状态迁移鉴权
- 步骤：用无迁移权限账号尝试改状态（如 创建->生效）。
- 期望：前端拦截并提示缺少 `status_transition` 权限码。
- 步骤：用有权限账号执行同样操作。
- 期望：状态修改成功并落库（`created/draft`、`active`、`locked/disabled` 映射正确）。

5. 手动推进
- 步骤：在运行页选择“下一任务”并提交推进。
- 期望：推进成功，当前任务切换为下一节点，审计日志新增 `TASK_TRANSITION`。

6. 自动推进
- 步骤：开启自动推进，业务行状态推进到触发状态。
- 期望：系统在轮询周期内自动推进到下一任务或完成实例。

7. 结束态
- 步骤：把流程推进到最后节点或标记完成。
- 期望：实例状态变为已完成，审计日志出现 `INSTANCE_COMPLETED`。

## 三、异常回归

1. 未绑定业务应用发起后点击“去业务处理”
- 期望：出现明确提示，不应静默失败。

2. 节点无状态映射
- 期望：不影响基础推进，但自动推进不应误推进。

3. 旧按表绑定遗留
- 期望：出现“旧按表绑定”提示并引导改为按应用绑定。

4. 多角色分派冲突
- 期望：`候选角色 OR 候选用户` 命中任一即可办理；均不命中则不可执行。

## 四、记录模板

每条用例记录：
- 用例编号
- 账号/角色
- 前置条件
- 操作步骤
- 实际结果
- 预期结果
- 是否通过（PASS/FAIL）
- 失败截图与日志关键字

建议失败日志关键字：
- `status transition permission required`
- `workflow transition permission required`
- `current task is not assigned to current actor`
- `42501` / `PGRST`

