# 权限点规范（EISCore）

本规范用于统一 **模块 / 应用 / 操作 / 字段** 权限的编码与落库规则，方便后续模块对接与 AI 自动生成。

## 1. 四级权限模型

1) 模块级（module）
- 作用：控制左侧菜单、首页入口卡片是否可见
- 示例：`module:hr` / `module:mms` / `module:home`

2) 应用级（app）
- 作用：控制是否允许进入某个应用页面
- 示例：`app:hr_employee` / `app:hr_org` / `app:hr_attendance`

3) 操作级（op）
- 作用：控制应用内部的核心操作
- 表格操作：新增/编辑/删除/导入/导出/列配置
- 按钮操作：部门新增/删除、保存布局、班次管理等
- 示例：`op:hr_employee.create` / `op:hr_org.delete`

4) 字段级（field）
- 作用：控制字段是否可见/可编辑
- 示例：`field:hr_employee.id_card.view` / `field:hr_employee.id_card.edit`
- 落库：使用 `public.sys_field_acl` 表，不放在 `permissions` 表

> 建议：角色权限以 **操作级为主**，模块/应用仅做入口开关；字段级仅用于敏感字段。

## 2. 权限码格式

```
module:{moduleKey}
app:{appKey}
op:{appKey}.{actionKey}
field:{appKey}.{fieldKey}.{actionKey}
```

- `moduleKey`：`home` / `hr` / `mms`
- `appKey`：如 `hr_employee` / `hr_org` / `mms_ledger`
- `actionKey`：`view|create|edit|delete|import|export|config|save_layout|member_manage|shift_manage|shift_create`

## 3. 落库规则（permissions 表）

`public.permissions` 仅存 **module/app/op** 三类权限点：

- `code`：唯一编码（唯一索引）
- `name`：展示名称（中文）
- `module`：展示分组（中文即可，如“模块/应用/人事花名册”）
- `action`：展示动作（中文即可，如“显示/进入/新增/编辑”）

> 真实鉴权以 `code` 为准，不依赖 `module/action` 字段。

## 4. 字段级权限（sys_field_acl 表）

字段权限存储在：

- `public.sys_field_acl(role_id, module, field_code, can_view, can_edit)`
- `module` 使用 `appKey`（如 `hr_employee`）
- `field_code` 为字段编码（如 `id_card`、`salary`）

对应到前端 DataGrid V2：会自动读取并控制列显示/可编辑。

## 5. 前端使用规范

- 菜单/入口：`hasPerm('module:hr')`
- 路由进入：`meta.perm = 'app:hr_employee'`
- 表格按钮：`op:xxx.create|delete|export|config`
- 字段权限：由 `sys_field_acl` 控制，不走 `permissions` 表

## 6. 权限种子与维护

建议统一通过 SQL 种子脚本维护：

- `eiscore-hr/sql/permission_seed.sql`

也可通过 RPC 批量同步（供前端/AI 调用）：

- `public.upsert_permissions(payload jsonb)`  
  POST `/rpc/upsert_permissions`，body 结构：`{ "payload": [ { code, name, module, action, roles? } ] }`
- `public.apply_role_permission_templates()`  
  POST `/rpc/apply_role_permission_templates`，一键应用默认角色模板

- `public.ensure_field_acl(module_name text, field_codes text[])`  
  POST `/rpc/ensure_field_acl`，为模块字段生成默认权限（全部可见/可编辑）

- `public.sync_field_acl_from_config()`  
  通过 `system_configs` 触发器自动执行，无需前端手动同步

字段权限注意点：
- 表内会出现“同一个字段多条记录”，因为每条记录是 **角色维度**（role_id + module + field_code）。

新增模块或应用时，需同步：
1) 补充权限种子
2) 更新前端 `hr-apps.js`
3) 如涉及字段权限，补充 `sys_field_acl` 规则

## 7. 默认角色模板（建议）

- 超级管理员：全部权限
- 人事管理员：HR 全操作权限
- 部门主管：可编辑部门内核心字段（禁身份证/工资）
- 员工：只读（仅查看 + 入口）

如需落库模板，可在后续增加 `role_permission_templates.sql`。
