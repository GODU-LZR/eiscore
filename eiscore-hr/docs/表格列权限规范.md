# 表格列权限规范（字段权限）

目标：让“应用表格列权限”真正影响前端表格显示与编辑，且列名与应用表格一致，避免反复出错。

## 一、现状与核心原则
- 权限表：`public.sys_field_acl(role_id, module, field_code, can_view, can_edit)`
- 列中文：`public.v_field_labels`（优先级：field_label_overrides > system_configs > 表字段注释）
- 角色范围：`role_data_scopes`（与列权限是两条不同链路）
- 前端表格必须在组件层统一执行列权限逻辑（隐藏/只读）

## 二、列权限生效链路（必须完整）
1) 应用保存列配置（system_configs）
2) 同步列中文（field_label_overrides 或 v_field_labels）
3) 确保 sys_field_acl 有对应字段（ensure_field_acl）
4) 表格组件在渲染阶段读取 sys_field_acl
   - `can_view=false`：列隐藏（不可见）
   - `can_view=true && can_edit=false`：列只读

缺一不可：只改 sys_field_acl 但表格不读取 → 不生效；只改前端不补齐 sys_field_acl → 权限配置看不到。

## 三、统一规范（给 AI / 开发使用）
### 1) 新增/编辑列时必须做的三件事
- 保存列配置到 system_configs
- 同步字段中文（field_label_overrides）
- 调用 `ensure_field_acl(module, field_codes[])`

### 2) 表格组件层必须做的两件事
- 拉取 `sys_field_acl`（基于当前用户角色 + module）
- 对每列执行：
  - can_view = false → `hide=true`
  - can_edit = false → 编辑禁用

### 3) 列名统一
- `v_field_labels` 为唯一中文来源
- 如果列 label 为空，必须 fallback 为 prop

## 四、常见反复问题与根因
1) **列权限设置了，但实际表格还可见**
   - 原因：表格组件未使用 sys_field_acl，或只做了“只读”未隐藏
2) **列权限配置里出现 ??? 或英文/重复**
   - 原因：field_label_overrides 未同步；system_configs 中列 label 为空；v_field_labels 来源不完整
3) **新列在权限配置里不出现**
   - 原因：没调用 ensure_field_acl 或 v_field_labels 未包含该列

## 五、排查步骤（快速定位）
1) `v_field_labels` 是否包含该列？
2) `sys_field_acl` 是否包含该列（对应 role_id + module）？
3) 前端表格组件是否拉取并隐藏/只读？

## 六、标准修复策略
1) 强制同步：
   - `ensure_field_acl` 全量补齐
   - `field_label_overrides` 回写中文
2) 组件层统一处理：
   - can_view → hide
   - can_edit → readOnly

