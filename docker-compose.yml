
services:
  db:
    image: postgres:16
    container_name: eiscore-db
    restart: always
    env_file:
      - ./env/.env
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-postgres123}"
      POSTGRES_DB: eiscore
    ports:
      - "5432:5432"
    volumes:
      - pgdata:/var/lib/postgresql/data
      # ğŸŸ¢ æŒ‚è½½é¡ºåºï¼šå…ˆåˆ›å»ºè§’è‰² (00)
      - ./env/init_roles.sql:/docker-entrypoint-initdb.d/00_init_roles.sql
      # ğŸŸ¢ å†å¯¼å…¥æ•°æ® (01)
      - ./env/db_schema_and_data.sql:/docker-entrypoint-initdb.d/01_init_schema.sql
      # ğŸŸ¢ åº”ç”¨ä¸­å¿ƒ Schema (02)
      - ./sql/app_center_schema.sql:/docker-entrypoint-initdb.d/02_app_center_schema.sql

  api:
    image: postgrest/postgrest
    container_name: eiscore-api
    ports:
      - "3000:3000"
    env_file:
      - ./env/.env
    environment:
      PGRST_DB_URI: "postgres://postgres:${POSTGRES_PASSWORD:-postgres123}@db:5432/eiscore"
      PGRST_DB_SCHEMAS: "public,hr,scm,app_center,workflow,app_data"
      PGRST_DB_ANON_ROLE: "web_anon"
      PGRST_JWT_SECRET: "${PGRST_JWT_SECRET:-my_super_secret_key_for_eiscore_system_2025}"
    depends_on:
       - db

  swagger:
    image: swaggerapi/swagger-ui
    container_name: eiscore-swagger
    restart: always
    ports:
      - "8079:8080"
    environment:
      BASE_URL: /doc
      API_URL: /api/
    depends_on:
      - api

  nginx:
    image: nginx:alpine
    container_name: eiscore-nginx
    restart: always
    ports:
      - "80:80"
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./nginx/html:/usr/share/nginx/html
    depends_on:
      - api
      - swagger

  agent-runtime:
    build: ./realtime
    container_name: eiscore-agent-runtime
    restart: always
    ports:
      - "8078:8078"
    env_file:
      - ./env/.env
    environment:
      PGHOST: db
      PGPORT: 5432
      PGUSER: postgres
      PGPASSWORD: "${POSTGRES_PASSWORD:-postgres123}"
      PGDATABASE: eiscore
      CHANNEL: eis_events
      PGRST_JWT_SECRET: "${PGRST_JWT_SECRET:-my_super_secret_key_for_eiscore_system_2025}"
      ANTHROPIC_API_KEY: "${ANTHROPIC_API_KEY:-}"
      FLASH_CLINE_ENABLED: "${FLASH_CLINE_ENABLED:-true}"
      FLASH_CLINE_COMMAND: "${FLASH_CLINE_COMMAND:-/app/node_modules/.bin/cline}"
      FLASH_CLINE_PROJECT_PATH: "${FLASH_CLINE_PROJECT_PATH:-eiscore-apps/src/views/drafts}"
      FLASH_CLINE_WORKDIR: "${FLASH_CLINE_WORKDIR:-/workspace/eiscore-apps/src/views/drafts}"
      FLASH_CLINE_CONFIG_ROOT: "${FLASH_CLINE_CONFIG_ROOT:-/tmp/flash-cline}"
      FLASH_CLINE_PROVIDER: "${FLASH_CLINE_PROVIDER:-openai}"
      FLASH_CLINE_TASK_TIMEOUT_MS: "${FLASH_CLINE_TASK_TIMEOUT_MS:-480000}"
    volumes:
      # Mount runtime source so index.js/agent-core.js/workflow-engine.js stay in sync
      - ./realtime:/app
      # Mount source code directories for file operations
      - ./eiscore-base:/workspace/eiscore-base
      - ./eiscore-hr:/workspace/eiscore-hr
      - ./eiscore-materials:/workspace/eiscore-materials
      - ./eiscore-apps:/workspace/eiscore-apps
    depends_on:
      - db

  code-server:
    image: linuxserver/code-server:latest
    container_name: eiscore-ide
    restart: unless-stopped
    environment:
      PUID: "${PUID:-1000}"
      PGID: "${PGID:-1000}"
      TZ: "${TZ:-Asia/Shanghai}"
      # Dev mode: keep both empty so linuxserver/code-server starts with --auth none.
      PASSWORD: ""
      HASHED_PASSWORD: ""
      SUDO_PASSWORD: "${CODE_SERVER_SUDO_PASSWORD:-}"
      # Cline compatibility/stability for extension host in web code-server runtime.
      NODE_OPTIONS: "--no-experimental-global-navigator"
      VSCODE_NODE_OPTIONS: "--max-old-space-size=4096 --no-experimental-global-navigator"
      DEFAULT_WORKSPACE: /config/workspace/drafts
      # Optional OpenAI-compatible endpoint values for Cline (set in env/.env when needed).
      CLINE_OPENAI_BASE_URL: "${CLINE_OPENAI_BASE_URL:-}"
      CLINE_OPENAI_API_KEY: "${CLINE_OPENAI_API_KEY:-}"
      CLINE_OPENAI_MODEL: "${CLINE_OPENAI_MODEL:-}"
    ports:
      - "8443:8443"
    read_only: true
    volumes:
      # åªè¯»æ ¹æ–‡ä»¶ç³»ç»Ÿä¸‹ï¼Œæä¾›è¿è¡Œæ—¶å¯æ‰§è¡Œ/å¯å†™ç›®å½•
      - code_server_tmp:/tmp
      - code_server_run:/run
      # code-server é…ç½®ä¸æ’ä»¶ç›®å½•ï¼ˆå¯å†™ï¼‰
      - ./config/code-server:/config
      # ä»…æŒ‚è½½é—ªå¿µè‰ç¨¿ç›®å½•ï¼Œé¿å…è¯¯æ”¹å·¥ç¨‹å…¶å®ƒæ–‡ä»¶
      - ./eiscore-apps/src/views/drafts:/config/workspace/drafts

volumes:
  pgdata:
  code_server_tmp:
  code_server_run:
