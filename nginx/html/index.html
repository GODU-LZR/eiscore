<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å—æ´¾é£Ÿå“ç‰©æ–™ç®¡ç†ç³»ç»Ÿ (MMS)</title>
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/element-plus"></script>
    <script src="https://unpkg.com/@element-plus/icons-vue"></script>
    <style>
        body { 
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', Arial, sans-serif; 
            background-color: #f0f2f5; 
            margin: 0;
            display: flex; 
            justify-content: center; 
            padding-top: 50px;
        }
        #app { width: 100%; max-width: 1000px; padding: 0 20px; }
        
        /* ç™»å½•å¡ç‰‡æ ·å¼ */
        .login-card { 
            max-width: 380px; 
            margin: 60px auto; 
            padding: 30px; 
            border-radius: 12px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.05); 
            background: #fff; 
        }
        .login-title {
            text-align: center; 
            color: #303133;
            margin-bottom: 30px;
            font-weight: 600;
        }

        /* ä¸»ç•Œé¢æ ·å¼ */
        .main-card { 
            background: #fff; 
            padding: 24px; 
            border-radius: 12px; 
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05); 
        }
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 24px; 
            border-bottom: 1px solid #ebeef5;
            padding-bottom: 16px;
        }
        .user-info {
            font-size: 14px;
            color: #606266;
        }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="!token" class="login-card">
            <h2 class="login-title">ğŸ” å‘˜å·¥ç™»å½•ç³»ç»Ÿ</h2>
            <el-form label-position="top" size="large">
                <el-form-item label="è´¦å·">
                    <el-input v-model="loginForm.username" placeholder="è¯·è¾“å…¥è´¦å· (ä¾‹å¦‚: zhangsan)" prefix-icon="User"></el-input>
                </el-form-item>
                <el-form-item label="å¯†ç ">
                    <el-input v-model="loginForm.password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " prefix-icon="Lock" show-password @keyup.enter="handleLogin"></el-input>
                </el-form-item>
                <el-button type="primary" style="width: 100%; margin-top: 20px; font-weight: bold;" @click="handleLogin" :loading="loading" size="large">
                    ç«‹å³ç™»å½•
                </el-button>
            </el-form>
        </div>

        <div v-else class="main-card">
            <div class="header">
                <div>
                    <h2 style="margin: 0 0 8px 0;">ğŸ“¦ åŸææ–™åº“å­˜å°è´¦</h2>
                    <span class="user-info">
                        å½“å‰æ“ä½œå‘˜: <el-tag effect="dark" type="primary" size="small">{{ currentUser }}</el-tag>
                    </span>
                </div>
                <div>
                    <el-button type="primary" plain @click="fetchData" :loading="loading" icon="Refresh">åˆ·æ–°æ•°æ®</el-button>
                    <el-button type="danger" plain @click="logout" icon="SwitchButton">é€€å‡ºç™»å½•</el-button>
                </div>
            </div>

            <el-table :data="tableData" stripe border style="width: 100%" v-loading="loading" empty-text="æš‚æ— æ•°æ®æˆ–æ— æƒæŸ¥çœ‹">
                <el-table-column prop="id" label="ID" width="80" align="center"></el-table-column>
                <el-table-column prop="batch_no" label="æ‰¹æ¬¡å·" width="180"></el-table-column>
                <el-table-column prop="name" label="ç‰©æ–™åç§°" min-width="120">
                    <template #default="scope">
                        <span style="font-weight: bold; color: #303133;">{{ scope.row.name }}</span>
                    </template>
                </el-table-column>
                <el-table-column prop="category" label="åˆ†ç±»" width="120">
                    <template #default="scope">
                        <el-tag size="small" type="success">{{ scope.row.category }}</el-tag>
                    </template>
                </el-table-column>
                <el-table-column prop="weight_kg" label="é‡é‡ (kg)" width="120" align="right"></el-table-column>
                <el-table-column prop="entry_date" label="å…¥åº“æ—¥æœŸ" width="150" align="center"></el-table-column>
                <el-table-column prop="created_by" label="å½•å…¥äºº" width="120" align="center">
                    <template #default="scope">
                        <el-tag type="info" size="small" effect="plain">{{ scope.row.created_by }}</el-tag>
                    </template>
                </el-table-column>
            </el-table>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        const { ElMessage } = ElementPlus;
        
        const app = createApp({
            setup() {
                // 1. å®šä¹‰å“åº”å¼å˜é‡
                const token = ref(localStorage.getItem('jwt_token') || '');
                const currentUser = ref(localStorage.getItem('user_name') || '');
                const loading = ref(false);
                const tableData = ref([]);
                const loginForm = ref({ username: 'zhangsan', password: '123456' });

                // ğŸ”µ æ ¸å¿ƒåŠŸèƒ½ï¼šç™»å½•
                const handleLogin = async () => {
                    if(!loginForm.value.username || !loginForm.value.password) {
                        return ElMessage.warning('è¯·è¾“å…¥è´¦å·å’Œå¯†ç ');
                    }
                    
                    loading.value = true;
                    try {
                        // è¯·æ±‚ PostgREST çš„ç™»å½•æ¥å£
                        const res = await fetch('/api/rpc/login', {
                            method: 'POST',
                            headers: { 
                                'Content-Type': 'application/json',
                                'Prefer': 'params=single-object' // å‘Šè¯‰åç«¯åªè¿”å›ä¸€ä¸ªå¯¹è±¡ï¼Œä¸è¦æ•°ç»„
                            },
                            body: JSON.stringify(loginForm.value)
                        });

                        // é”™è¯¯å¤„ç†
                        if (!res.ok) {
                            const err = await res.json();
                            throw new Error(err.message || 'ç™»å½•å¤±è´¥ï¼Œè¯·æ£€æŸ¥è´¦å·å¯†ç ');
                        }

                        const data = await res.json(); 
                        
                        // å…¼å®¹å¤„ç†ï¼šPostgREST å¯èƒ½è¿”å› {"token": "..."} ä¹Ÿå¯èƒ½è¿”å› "eyJ..." å­—ç¬¦ä¸²
                        // æˆ‘ä»¬ä¹‹å‰çš„ login å‡½æ•°è¿”å›çš„æ˜¯ json å¯¹è±¡ {'token': ...}
                        const jwt = data.token || data; 

                        if (!jwt) throw new Error('æœåŠ¡å™¨æœªè¿”å›æœ‰æ•ˆ Token');

                        // âœ… ç™»å½•æˆåŠŸï¼Œä¿å­˜ä¿¡æ¯
                        token.value = jwt;
                        currentUser.value = loginForm.value.username;
                        
                        localStorage.setItem('jwt_token', jwt);
                        localStorage.setItem('user_name', currentUser.value);
                        
                        ElMessage.success('ç™»å½•æˆåŠŸï¼æ¬¢è¿å›æ¥');
                        fetchData(); // ç™»å½•åç«‹å³æŸ¥æ•°æ®

                    } catch (e) {
                        console.error(e);
                        ElMessage.error(e.message);
                    } finally {
                        loading.value = false;
                    }
                };

                // ğŸŸ¢ æ ¸å¿ƒåŠŸèƒ½ï¼šå¸¦ Token æŸ¥æ•°æ®
                const fetchData = async () => {
                    if (!token.value) return;
                    
                    loading.value = true;
                    try {
                        const res = await fetch('/api/raw_materials?order=id.asc', {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json',
                                // âœ¨ å…³é”®ç‚¹ï¼šæŠŠ Token æ”¾å…¥è¯·æ±‚å¤´
                                'Authorization': `Bearer ${token.value}`
                            }
                        });

                        if (res.status === 401) {
                            logout(); // Token è¿‡æœŸæˆ–æ— æ•ˆï¼Œå¼ºåˆ¶é€€å‡º
                            throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
                        }

                        const data = await res.json();
                        tableData.value = data;
                    } catch (e) {
                        ElMessage.error(e.message || 'æ•°æ®åŠ è½½å¤±è´¥');
                    } finally {
                        loading.value = false;
                    }
                };

                // ğŸ”´ é€€å‡ºåŠŸèƒ½
                const logout = () => {
                    token.value = '';
                    currentUser.value = '';
                    localStorage.removeItem('jwt_token');
                    localStorage.removeItem('user_name');
                    tableData.value = [];
                    ElMessage.info('å·²é€€å‡ºç™»å½•');
                };

                // é¡µé¢åŠ è½½æ—¶ï¼Œå¦‚æœæœ¬åœ°æœ‰ Tokenï¼Œè‡ªåŠ¨æŸ¥æ•°æ®
                onMounted(() => {
                    if (token.value) {
                        fetchData();
                    }
                });

                return {
                    token,
                    currentUser,
                    loading,
                    tableData,
                    loginForm,
                    handleLogin,
                    fetchData,
                    logout
                };
            }
        });

        // æ³¨å†Œæ‰€æœ‰å›¾æ ‡
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component)
        }

        app.use(ElementPlus).mount('#app');
    </script>
</body>
</html>